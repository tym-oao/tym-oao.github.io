<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width" initial-scale=1>
  <title>TYM engineering notes</title>
  <link href="theme/normalize.min.css" rel="stylesheet" >
  <link href="theme/main.css" rel="stylesheet" />
  <link href="theme/solarizeddark.css" rel="stylesheet" />
  <script src="https://use.fontawesome.com/72ee4db781.js"></script>
</head>
<body>
<div class='small topmenu'><p><a href="/">Home</a> | <a href="/archives.html">Archives</a></p></div>

<div id="banner">
	<div class="container">
		<div class="copy">
			<h1><a href="/">TYM engineering notes</a></h1>
		</div>
	</div>
</div><div id=main>
            <article>
                <h2><a href="/postgres-monitoring-trial-findings.html">Postgres Monitoring Trial Findings</a></h2>
                <div class="entry-content"><p>In order to supplement the <a href="http://devblog.ty-m.xyz/postgres-monitoring.html">monitoring available in Stackdriver</a>, I took a look at a number of options, as noted in <a href="https://trello.com/c/1pWdNWVM">this card</a>.</p>
<h2>TL;DR</h2>
<p>I'm not overjoyed about any of the solutions I tried, although OPM could do the job if we can't come up with anything else.</p>
<h2><a href="https://no0p.github.io/pgantenna/">pgantenna</a></h2>
<p>This looked promising, based on the style of the project homepage, and the  helpful documentation. There was already a <a href="https://hub.docker.com/r/no0p/pgantenna/">docker image</a> available, so getting this up and running was simple.</p>
<p>The app gathers data from a Postgres extension called <a href="http://no0p.github.io/pgsampler/">pgsampler</a>. Building this and installing it a postgres container was easy and straightforward: <code>make &amp;&amp; make install</code> and then add to <code>postgresql.conf</code> as a shared_preload_libraries value.</p>
<p>Unfortunately, the pgantenna server just served a default Apache page on port 80, and I was unable to noodle out what the URL for the pgantenna app. At this point I noticed that the project hasn't had a new commit in 2 years, so it was unlikely that asking the developer for help would do much, and I abandoned the effort here.</p>
<p><strong>Verdict</strong>: doesn't actually work.</p>
<h2><a href="http://opm.io/">OPM</a></h2>
<p>This turns out to be a vended distribution of Nagios, with a custom UI wrapper, and with config and commands for Postgres already included (although still requiring further customization), and its own <a href="https://github.com/OPMDG/check_pgactivity">Nagios plugin</a> (an alternative to the more widely-used <a href="https://bucardo.org/wiki/Check_postgres"><code>check_postgres</code></a>).</p>
<h4>Pros</h4>
<ul>
<li>Can do everything Nagios does (threshold-based altering + some metric graphs) without so much of the Nagios setup. Indeed, it actually <em>is</em> Nagios, with some of the Postgres-specific stuff taken care of already.</li>
<li>Nicer looking front-end than Nagios for monitoring</li>
<li><code>check_pgactivity</code> does a lot of the more useful things in <code>check_postgres</code> without as much complexity/bloat. Certainly covers what we're looking for.</li>
</ul>
<h4>Cons</h4>
<ul>
<li>It's still Nagios, therefore an ugly beast</li>
<li>Feels like both more and less than what I'm looking for (i.e., too heavyweight but also not great).</li>
</ul>
<p><strong>Verdict</strong>: Could be workable, but I'm not sold</p>
<h4>Next Steps</h4>
<ul>
<li>Research/investigate Stackdriver custom metrics as a way to do this monitoring<ul>
<li>Would have the advantage of integration with GCP account and the monitoring we are already using it for</li>
</ul>
</li>
<li>Draft more detailed plan for "rolling our own" solution<ul>
<li>Unlike my earlier post, I would be interested not in setting up a Graphite server, but a CLI thing like <a href="https://github.com/zalando/pg_view">pg_view</a>.</li>
<li>Although, we'd still have to solve the problem of active/push altering</li>
</ul>
</li>
</ul>
                    <!-- <a class="btn btn-default btn-xs" href="/postgres-monitoring-trial-findings.html">more ...</a> -->
                </div>
                <footer class="storyfoot">
                    <abbr class="storydate" title="2016-11-08T12:07:58-06:00"> <a href="/postgres-monitoring-trial-findings.html" rel="bookmark" title="Permalink to Postgres Monitoring Trial Findings">2016-11-08 12:07:58</a></abbr>&nbsp;<a href="http://maps.google.com/maps?q=41.888791,-87.632138" class="icon"><i class="fa fa-map-marker fa-lg"></i></a>
                </footer><!-- /.post-info -->
            </article>

            <!-- <hr/> -->
            <article>
                <h2><a href="/postgres-monitoring.html">Postgres Monitoring</a></h2>
                <div class="entry-content"><h2>What we have in place</h2>
<h4>Monitors</h4>
<p>Via <a href="https://app.google.stackdriver.com/services/postgresql">Stackdriver</a>:</p>
<ul>
<li>Connections (count): Number of connections to PostgreSQL.</li>
<li>Disk Usage (byte): Number of bytes currently being used on disk.</li>
<li>Commits (count/s): Number of commits per second.</li>
<li>Rollbacks (count/s): Number of rollbacks per second.</li>
<li>Heap Blocks Read Rate (count/s): Number of blocks read from the heap.</li>
<li>Heap Cache Hit Rate (count/s): Number of blocks read directly out of the cache.</li>
<li>Index Blocks Read Rate (count/s): Number of blocks read from the index.</li>
<li>Index Cache Hit Rate (count/s): Number of index blocks read directly out of the cache.</li>
<li>Toast Blocks Read Rate (count/s): Number of reads from the toast blocks.</li>
<li>Toast Cache Hit Rate (count/s): Number of toast blocks read directly out of the cache.</li>
<li>Toast Index Blocks Read Rate (count/s): Number of blocks read from the toast index.</li>
<li>Toast Index Cache Hit Rate (count/s): Number of toast index blocks read directly out of the cache.</li>
<li>Operations [delete, insert, update, heap only update] (count/s): Number of rows [deleted, inserted, updated, heap only updated] in the db.</li>
<li>Dead Tuples (count): Number of tuples that are dead in the db.</li>
<li>Live Tuples (count): Number of tuples that are live in the db.</li>
</ul>
<p>Plus CPU, RAM, disk, and network traffic stats on the host</p>
<p>All of the above are simply being passively monitored; we don't have any threshold-based alerting on any metrics.</p>
<h4>Alerting policies</h4>
<ul>
<li>Uptime Check Health on mart.pgdata.xyz fails</li>
<li>Uptime Check Health on warehouse.pgdata.xyz fails</li>
<li>CPU Usage is absent for greater than 5 minutes from warehouse.pgdata.xyz</li>
<li>CPU Usage is absent for greater than 10 minutes from api-postgres</li>
<li>CPU Usage is absent for greater than 5 minutes from mart-postgres</li>
</ul>
<p>When raised, these all send notice to the #data channel in Slack, and push notification to TYM via the Google Could Console app.</p>
<h2>What we should still add</h2>
<h4>Things to monitor</h4>
<ul>
<li>Count of database locks</li>
<li>Duration of queries (avg, longest-running)</li>
<li>Count and duration of idle-in-transaction connections</li>
<li>Last checkpoint</li>
<li>Actual uptime based on database connection (existing checks use ping or CPU metric availability)</li>
</ul>
<h4>Things to alert on</h4>
<ul>
<li>blocking locks (at all)</li>
<li>exclusive locks (threshold-based)</li>
<li>connections waiting for a lock (threshold-based)</li>
<li>long-running queries</li>
</ul>
<h4>Some options (needs research)</h4>
<ul>
<li>Custom metrics via Stackdriver API</li>
<li><a href="https://no0p.github.io/pgantenna/">pgantenna</a></li>
<li><a href="http://opm.io/">OPM</a> (Don't miss <a href="https://github.com/yuhuman/OPM-Docker">Dockerized</a> version)</li>
<li>Roll our own check_postgres, Nagios, collectd, graphite server</li>
</ul>
                    <!-- <a class="btn btn-default btn-xs" href="/postgres-monitoring.html">more ...</a> -->
                </div>
                <footer class="storyfoot">
                    <abbr class="storydate" title="2016-10-11T18:04:22+00:00"> <a href="/postgres-monitoring.html" rel="bookmark" title="Permalink to Postgres Monitoring">2016-10-11 18:04:22</a></abbr>&nbsp;<a href="http://maps.google.com/maps?q=42.0717804175097,-87.7154614593466" class="icon"><i class="fa fa-map-marker fa-lg"></i></a>
                </footer><!-- /.post-info -->
            </article>

            <!-- <hr/> -->
            <article>
                <h2><a href="/stackdriver.html">Stackdriver</a></h2>
                <div class="entry-content"><p>I've been studying <a href="https://cloud.google.com/stackdriver/">Stackdriver Monitoring</a> for Google Cloud, and setting up simple alerts and metric dashboards. I wrote up my findings on <a href="https://github.com/tym-oao/tym-oao.github.io/wiki/Stackdriver-Monitoring">this wiki page</a>.</p>
                    <!-- <a class="btn btn-default btn-xs" href="/stackdriver.html">more ...</a> -->
                </div>
                <footer class="storyfoot">
                    <abbr class="storydate" title="2016-07-19T03:31:03+00:00"> <a href="/stackdriver.html" rel="bookmark" title="Permalink to Stackdriver">2016-07-19 03:31:03</a></abbr>&nbsp;<a href="http://maps.google.com/maps?q=42.0718216760994,-87.7153549129115" class="icon"><i class="fa fa-map-marker fa-lg"></i></a>
                </footer><!-- /.post-info -->
            </article>

            <!-- <hr/> -->
            <article>
                <h2><a href="/using-pg_serviceconf-with-luigi.html">Using pg_service.conf with Luigi</a></h2>
                <div class="entry-content"><p>I was thinking about the pg_service.conf post I wrote yesterday, and wondering how to follow that practice in <a href="http://luigi.readthedocs.io/">Luigi</a>. It's a little tricky, because <a href="http://luigi.readthedocs.io/en/stable/api/luigi.postgres.html"><code>luigi.postgres</code></a> implements instances of <code>luigi.contrib.rdbms</code> abstract classes, and therefore expects all the abstract properties (i.e., host, database, etc.) to be specified. So, when I tried simply overriding the <code>connect()</code> method of <code>PostgresTarget</code> I was getting TypeErrors because those abstract methods weren't implemented.</p>
<p>I didn't want to build this up from a generic Luigi <code>Task</code>, because <code>luigi.postgres</code> and <code>luigi.contrib.rdbms</code> have a lot of really useful stuff already implemented that I would have had to repeat for myself. In the end, I found that I could just set the <code>rdms</code> properties to <code>None</code> defaults and then ignore them, while overriding <code>PostgresTarget.connect()</code> the way I wanted to. The resulting template tasks, along with a couple of simple examples of subclassing them for specific jobs are in <a href="https://gist.github.com/yagermadden/d515f0b1dde2c4cdd6c192e08bb33e00">this Gist</a> which is also shown below:</p>
<div class="gist">
    <script src='https://gist.github.com/d515f0b1dde2c4cdd6c192e08bb33e00.js'></script>
    <noscript>
        <pre><code>import luigi
import luigi.postgres
import psycopg2
import os

testdata = ([99, 'My fake plants died because I did not pretend to water'
             ' them.'],
            [100, 'I always arrive late at the office, '
            'but I make up for it by leaving early.'],
            [101, u'∩ ∪'])


class PgServiceTarget(luigi.postgres.PostgresTarget):
    """
    Target for a resource in PostgreSQL, overriding the standard PostgresTarget
    to use a pg_service.conf service name to make the connection instead of
    separate connection params
    """
    def __init__(self, service, update_id, table):
        """
        Args:
            service (str): the name of a service defined in local
                pg_service.conf file
            update_id (str): An identifier for this data set
        """
        self.service = service
        self.update_id = update_id
        self.table = table

    def connect(self):
        """
        Get a psycopg2 connection object to the database where the table is.
        """
        connection = psycopg2.connect(
            service=self.service)
        connection.set_client_encoding('utf-8')
        return connection


class PgServiceQuery(luigi.postgres.PostgresQuery):
    """
    Template task for querying a PostgreSQL database, with standard output
    method overridden to return a PgServiceTarget
    """
    # Handle the properties expected by abstract class rdbms.Query
    host = None
    database = None
    user = None
    password = None

    def output(self):
        return PgServiceTarget(service=self.service, table=self.table, update_id=self.update_id)


class PgCopyToTable(luigi.postgres.CopyToTable):
    """
    Template task for inserting a data set into Postgres via PgServiceTarget
    """
    # Handle the properties expected by abstract class rdbms.Query
    host = None
    database = None
    user = None
    password = None

    def output(self):
        return PgServiceTarget(service=self.service, table=self.table, update_id=self.update_id)


class PgExampleQuery(PgServiceQuery):
    env_service = os.getenv('PGSERVICE', 'local')
    service = luigi.Parameter(default=env_service)
    table = 'whoa'
    query = 'create table whoa (trival_id serial, whoa_txt text)'


class PgExampleLoad(PgCopyToTable):
    env_service = os.getenv('PGSERVICE', 'local')
    service = luigi.Parameter(default=env_service)
    table = 'whoa'
    columns = [("trival_id", "INT"),
               ("description", "TEXT")]

    def rows(self):
        for record in testdata:
            yield record
</code></pre>
    </noscript>
</div>
                    <!-- <a class="btn btn-default btn-xs" href="/using-pg_serviceconf-with-luigi.html">more ...</a> -->
                </div>
                <footer class="storyfoot">
                    <abbr class="storydate" title="2016-07-14T17:42:15+00:00"> <a href="/using-pg_serviceconf-with-luigi.html" rel="bookmark" title="Permalink to Using pg_service.conf with Luigi">2016-07-14 17:42:15</a></abbr>&nbsp;<a href="http://maps.google.com/maps?q=41.8892138776688,-87.6328944003586" class="icon"><i class="fa fa-map-marker fa-lg"></i></a>
                </footer><!-- /.post-info -->
            </article>

            <!-- <hr/> -->
            <article>
                <h2><a href="/pg_service-psycopg2.html">pg_service + psycopg2 = ❤️</a></h2>
                <div class="entry-content"><p>A couple of days ago I learned about the <a href="https://www.postgresql.org/docs/current/static/libpq-pgservice.html">pg_service.conf file</a> in Postgres, and posted about it to my teammates in Slack. It lets you store connection parameters under single service names, using square-bracked "INI file" format. This makes connecting to frequently-used hosts and databases much easier. For example, with a <code>pg_service.conf</code> like...</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">[mydb]</span>
<span class="na">host</span><span class="o">=</span><span class="s">somehost</span>
<span class="na">port</span><span class="o">=</span><span class="s">5433</span>
<span class="na">user</span><span class="o">=</span><span class="s">someuser</span>
<span class="na">dbname</span><span class="o">=</span><span class="s">mydatabase</span>
</pre></div>
</td></tr></table>

<p>...then you can go <code>PGSERVICE=mydb psql</code> at the command line, and Bob's your uncle. (This is extra handy if you have the <code>PGPASSWORD</code> envar set to the password for <code>someuser</code>.) Instead of always setting the PGSERVICE variable, I also export that to my most-often-used service (the warehouse instance, in my case) in my <code>.bashrc</code>. Another way I made this easier on myself is with by adding a simple alias-like function (I used a function because aliases can't take arguments):</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span>pg<span class="o">()</span> <span class="o">{</span> <span class="nv">PGSERVICE</span><span class="o">=</span><span class="nv">$1</span> psql

<span class="o">}</span>
</pre></div>
</td></tr></table>

<p>The other noteworthy thing here, is that the defined services work at the libpq level, which means that any native postgresql driver (for instance psycopg2 😉) can use them as well.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">psycopg2</span>

<span class="n">conn</span> <span class="o">=</span> <span class="n">psycopg2</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">service</span><span class="o">=</span><span class="s1">&#39;mydb&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;secret&#39;</span><span class="p">)</span>  <span class="c1"># or set PGPASSWORD</span>
</pre></div>
</td></tr></table>

<p>I made a more complete example in <a href="https://gist.github.com/tym-oao/33baf67bb332cebc4b20f7211dbedf59">this gist</a>. I suggest we should use this manner of provisioning database connections as a matter of policy:</p>
<ul>
<li><code>ADD</code> a pg_service.conf file to your Docker image (likely better: provide for one to be mounted in at run time).</li>
<li>Use Kubernetes secret to set <code>PGPASSWORD</code> in the environment</li>
<li>Pass the service name to the psycopg2 (or whichever driver) connection method</li>
</ul>
<p>It just makes sense.</p>
                    <!-- <a class="btn btn-default btn-xs" href="/pg_service-psycopg2.html">more ...</a> -->
                </div>
                <footer class="storyfoot">
                    <abbr class="storydate" title="2016-07-13T16:13:30+00:00"> <a href="/pg_service-psycopg2.html" rel="bookmark" title="Permalink to pg_service + psycopg2 = ❤️">2016-07-13 16:13:30</a></abbr>&nbsp;<a href="http://maps.google.com/maps?q=41.8892418555794,-87.6326868892114" class="icon"><i class="fa fa-map-marker fa-lg"></i></a>
                </footer><!-- /.post-info -->
            </article>

            <!-- <hr/> -->
            <article>
                <h2><a href="/corrupt-database-disk-issue-at-gce.html">Corrupt database disk issue at GCE</a></h2>
                <div class="entry-content"><p>Posting this here mainly in case this issue happens to come up again. I've noticed several cases in recent cloud console Notification Activity in which repeated disk-attachment errors were reported. In those cases I didn't notice any database service outages, but this still seems like something that could end up not being an isolated incident.</p>
<h3>Problem</h3>
<ul>
<li>Between 22:10 and 22:20 on 2016-06-29, the Google cloud console Activity record shows that the persistent disks mounted to nodes in the <code>warehouse-provisioning-1</code> k8s cluster detached themselves from the instances they had been attached to.</li>
<li>I say "detached themselves" because neither myself nor anyone at OAO executed any k8s commands to explicitly detach them. The root cause for the detachment is uncertain.</li>
<li>The timing of <a href="https://status.cloud.google.com/incident/compute/16011">this SSD latency incident incident</a> from the GCE <a href="https://status.cloud.google.com">status page</a> seems to coincide with when these detachments happened. I imagine that disks might have had to be detached and reattached as part of whatever Google engineers did to resolve the issue, but that's a guess on my part.</li>
<li>In any case, while the disks were also automatically reattached, the abrupt disconnection left them in an inconsistent state, so that Postgres instances which use these disk mounts for storage were unable to start due to I/O errors.</li>
<li>Result: <code>warehouse-postgres</code> and <code>mart-postgres</code> instances were down since roughly 22:19.</li>
</ul>
<h3>Resolution</h3>
<p>Basically, to get things working again, I had to <code>fsck</code> the affected disks, then detach them from the instances they were attached to with a <code>gcloud</code> command. So, for example, in the case of the disk <code>mart-data-disk</code> attached to <code>warehouse-provisioning-1-fde62020-node-8n9r</code> I had to:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span>ssh warehouse-provisioning-1-fde62020-node-8n9r <span class="se">\</span>
sudo fsck.ext4 -v -y /dev/disk/by-id/google-mart-data-disk
gcloud compute instances detach-disk <span class="se">\</span>
gke-warehouse-provisioning-1-fde62020-node-8n9r --disk mart-data-disk
</pre></div>
</td></tr></table>

<p>Then restart the <code>mart-postgres</code> as usual with <code>kubectl create -f mart-postgres.yaml</code>.</p>
                    <!-- <a class="btn btn-default btn-xs" href="/corrupt-database-disk-issue-at-gce.html">more ...</a> -->
                </div>
                <footer class="storyfoot">
                    <abbr class="storydate" title="2016-06-29T22:54:20+00:00"> <a href="/corrupt-database-disk-issue-at-gce.html" rel="bookmark" title="Permalink to Corrupt database disk issue at GCE">2016-06-29 22:54:20</a></abbr>&nbsp;<a href="http://maps.google.com/maps?q=41.8828766952614,-87.64016439234" class="icon"><i class="fa fa-map-marker fa-lg"></i></a>
                </footer><!-- /.post-info -->
            </article>

            <!-- <hr/> -->
            <article>
                <h2><a href="/self-referential-todo.html">Self-referential TODO</a></h2>
                <div class="entry-content"><p><s>While I want to keeping the styling and build of this page brutally simple, one thing I should consider adding is <a href="http://pygments.org/">pygments</a> or similar for code syntax highlighting.</s> <em>(UPDATE: done!)</em></p>
<p><s>Also, look into why <a href="https://github.com/yagermadden/straplessdown">straplessdown</a> is stripping inline HTML from the markdown source section. 😕 </s> <em>(UPDATE: wontfix; using Pelican now instead.)</em></p>
                    <!-- <a class="btn btn-default btn-xs" href="/self-referential-todo.html">more ...</a> -->
                </div>
                <footer class="storyfoot">
                    <abbr class="storydate" title="2016-06-23T07:24:35-05:00"> <a href="/self-referential-todo.html" rel="bookmark" title="Permalink to Self-referential TODO">2016-06-23 07:24:35</a></abbr>&nbsp;<a href="http://maps.google.com/maps?q=42.0718055142177,-87.7152488015581" class="icon"><i class="fa fa-map-marker fa-lg"></i></a>
                </footer><!-- /.post-info -->
            </article>

            <!-- <hr/> -->

        <ul class="pager">
                <li class="previous disabled"><a href="#">&larr; Newer</a></li>
                <li class="next"><a
                        href="/category/misc2.html">Older &rarr;</a></li>
        </ul>

</div>
</div>
<footer class="foot-foot">
   <div class="container">
      <!-- <hr> -->
      <div class="row">
         <div class="col-xs-10 small"><p>&copy; 2016 <a href="https://github.com/tym-oao">Thomas</a><br>
             <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/" class="svg">
                 <object type="image/svg+xml" data="images/cc-by-sa.svg"></object></a>  Some rights reserved. <br>
             Hypertext rendered with
            <a href="http://docs.getpelican.com/" target="_blank">Pelican</a></p>


         </div>
         <div class="col-xs-2"><p class="pull-right"><a href="#"><i class="fa fa-arrow-up"></i></a></p></div>
      </div>
   </div>
</footer>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-82820361-3', 'auto');
  ga('send', 'pageview');

</script>

</body>
</html>