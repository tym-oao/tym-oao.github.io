<!DOCTYPE html>
<html lang="en-US">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width" initial-scale="1">
  <title>TYM engineering notes</title>
  <link href="theme/main.min.css" rel="stylesheet" />
  <link href="theme/solarized-light.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans|Gentium+Basic|Inconsolata" />
  <link rel="icon" href="data:," />
</head>
<body>

<div class="banner">
    <div class="toplogo">
		<h1><a href="./">TYM engineering notes</a></h1>
	</div>
    <div class='topmenu small'>
        <p><a href="./">Home</a> | <a href="./archives.html">Archives</a></p>
    </div>
</div>
<div class="main">
    <article>
        <div class="entry-content">
            <h2 class="entry-head">
                &sect;
            </h2>
            <p>Posting this here mainly in case this issue happens to come up again. I've noticed several cases in recent cloud console Notification Activity in which repeated disk-attachment errors were reported. In those cases I didn't notice any database service outages, but this still seems like something that could end up not being an isolated incident.</p>
<h3>Problem</h3>
<ul>
<li>Between 22:10 and 22:20 on 2016-06-29, the Google cloud console Activity record shows that the persistent disks mounted to nodes in the <code>warehouse-provisioning-1</code> k8s cluster detached themselves from the instances they had been attached to.</li>
<li>I say "detached themselves" because neither myself nor anyone at OAO executed any k8s commands to explicitly detach them. The root cause for the detachment is uncertain.</li>
<li>The timing of <a href="https://status.cloud.google.com/incident/compute/16011">this SSD latency incident incident</a> from the GCE <a href="https://status.cloud.google.com">status page</a> seems to coincide with when these detachments happened. I imagine that disks might have had to be detached and reattached as part of whatever Google engineers did to resolve the issue, but that's a guess on my part.</li>
<li>In any case, while the disks were also automatically reattached, the abrupt disconnection left them in an inconsistent state, so that Postgres instances which use these disk mounts for storage were unable to start due to I/O errors.</li>
<li>Result: <code>warehouse-postgres</code> and <code>mart-postgres</code> instances were down since roughly 22:19.</li>
</ul>
<h3>Resolution</h3>
<p>Basically, to get things working again, I had to <code>fsck</code> the affected disks, then detach them from the instances they were attached to with a <code>gcloud</code> command. So, for example, in the case of the disk <code>mart-data-disk</code> attached to <code>warehouse-provisioning-1-fde62020-node-8n9r</code> I had to:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span>ssh warehouse-provisioning-1-fde62020-node-8n9r <span class="se">\</span>
sudo fsck.ext4 -v -y /dev/disk/by-id/google-mart-data-disk
gcloud compute instances detach-disk <span class="se">\</span>
gke-warehouse-provisioning-1-fde62020-node-8n9r --disk mart-data-disk
</pre></div>
</td></tr></table>

<p>Then restart the <code>mart-postgres</code> as usual with <code>kubectl create -f mart-postgres.yaml</code>.</p>
        </div>
        <div class="entry-foot">
            <p class="small"><a href="./corrupt-database-disk-issue-at-gce.html" rel="bookmark" title="Permalink to Corrupt database disk issue at GCE">
                2016-06-29 22:54:20+00:00</a><br>
                                    <object type="image/svg+xml" data="images/w3w.svg" width="15" class="svg"></object>
                    </a></p>
        </div>
    </article>

</div>

<footer class="foot-foot">
      <div class="row">
         <div class="small"><p><a href="https://github.com/tym-oao">Thomas</a></p>
             <p><a rel="license" href="https://creativecommons.org/publicdomain/zero/1.0/" class="svg">
             <object type="image/svg+xml" data="images/cc-zero.svg"></object>
              No rights reserved.</a></p>
             <p>PGP Fingerprint: 640F FCD3 C75C F970 58B1 9EB7 FA74 DA49 25D1 F373</p>
             <p><a href="https://keybase.io/tym/key.asc">PGP key</a></p>
             <p class="small">Mad props: <a href="https://blog.getpelican.com/">Pelican</a>, <a href="https://www.docker.com/community-edition">Docker</a>, <a href="https://coreos.com/os/docs/latest/">CoreOS</a>, <a href="https://lighttpd.net">lighttpd</a>, <a href="https://www.digitalocean.com/">DigitalOcean</a></p>
         </div>
      </div>
</footer>
</body>
</html>