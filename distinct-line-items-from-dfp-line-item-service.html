<!DOCTYPE html>
<html lang="en-US">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width" initial-scale="1">
  <title>TYM engineering notes</title>
  <link href="theme/main.min.css" rel="stylesheet" />
  <link href="theme/solarized-light.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans|Gentium+Basic|Inconsolata" />
  <link rel="icon" href="data:," />
</head>
<body>

<div class="banner">
    <div class="toplogo">
		<h1><a href="./">TYM engineering notes</a></h1>
	</div>
    <div class='topmenu small'>
        <p><a href="./">Home</a> | <a href="./archives.html">Archives</a></p>
    </div>
</div>
<div class="main">
    <article>
        <div class="entry-content">
            <h2 class="entry-head">
                &sect;
            </h2>
            <p>Over time, the table <code>warehouse_hold.hold_dfp_line_item</code> has accumulated many rows for each line item. In most cases this is due to changes in the line item configuration or status; it is also due to overlapping attempts to bring the data up-to-date. In any case, Analytics is interested only in the most recent record for each item. As noted in <a href="https://trello.com/c/ygfrMXJr/615-warehouse-etl-investigate-and-fix-line-item-discrepancies-between-dfp-and-hold-dfp-line-item-table">Trello</a>, I created a new <code>hold_dfp_line_item_distinct</code> table, to include one record per line_item_id, based on maximum <code>last_modified_date_time</code> and <code>created_at</code> values.</p>
<p>Oddly (says I), while a CTE defined as</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">select</span> <span class="k">max</span><span class="p">(</span><span class="n">last_modified_date_time</span><span class="p">)</span> <span class="k">as</span> <span class="n">last_modified_date_time</span>
     <span class="p">,</span> <span class="k">max</span><span class="p">(</span><span class="n">created_at</span><span class="p">)</span> <span class="k">as</span> <span class="n">created_at</span>
     <span class="p">,</span> <span class="n">line_item_id</span>
  <span class="k">from</span> <span class="n">hold_dfp_line_item</span>
 <span class="k">group</span> <span class="k">by</span> <span class="mi">3</span>
</pre></div>
</td></tr></table>

<p>has the expected number of rows, joining that on all three columns back to the main table resulted in a small number (39 out of about a million) of duplicate rows.</p>
<p>I have been able to resolve the matter by using <code>select distinct</code>  in the main query, but I don't understand why it should be necessary.</p>
<p>Also, as we update with new pulls from the line item service, we'll begin to have multiple rows per line item again, and if this simplified table is desirable in Hold, we'll have to keep refreshing it. Therefore, we will eventually find out whether the duplication of the same line item at the same created_at timestamp was a one-time glitch, or something ongoing. In the former case, we should remove the <code>distinct</code> from the query, for performance reasons. This note is here as a reminder</p>
        </div>
        <div class="entry-foot">
            <p class="small"><a href="./distinct-line-items-from-dfp-line-item-service.html" rel="bookmark" title="Permalink to Distinct line items from DFP line item service">
                2016-05-18 00:00:00-05:00</a><br>
                                    <object type="image/svg+xml" data="images/w3w.svg" width="15" class="svg"></object>
                    </a></p>
        </div>
    </article>

</div>

<footer class="foot-foot">
      <div class="row">
         <div class="small"><p><a href="https://github.com/tym-oao">Thomas</a></p>
             <p><a rel="license" href="https://creativecommons.org/publicdomain/zero/1.0/" class="svg">
             <object type="image/svg+xml" data="images/cc-zero.svg"></object>
              No rights reserved.</a></p>
             <p>PGP Fingerprint: 640F FCD3 C75C F970 58B1 9EB7 FA74 DA49 25D1 F373</p>
             <p><a href="https://keybase.io/tym/key.asc">PGP key</a></p>
             <p class="small">Mad props: <a href="https://blog.getpelican.com/">Pelican</a>, <a href="https://www.docker.com/community-edition">Docker</a>, <a href="https://coreos.com/os/docs/latest/">CoreOS</a>, <a href="https://lighttpd.net">lighttpd</a>, <a href="https://www.digitalocean.com/">DigitalOcean</a></p>
         </div>
      </div>
</footer>
</body>
</html>